<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coach Appointment Payment & Booking</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // Read safely injected JSON config
  const appConfigEl = document.getElementById("app-config");
  const { firebaseConfig, supabaseConfig } = JSON.parse(appConfigEl.textContent.trim());
  console.log("üî• Firebase Config Loaded:", firebaseConfig);

  // Assign Firebase config globally
  window.__firebase_config = firebaseConfig;

  // Setup Supabase client
  const SUPABASE_URL = supabaseConfig.url;
  const SUPABASE_ANON_KEY = supabaseConfig.anonKey;

  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.error("‚ùå Supabase configuration missing");
  } else {
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("‚úÖ Supabase client initialized:", SUPABASE_URL);
  }

  window.uploadBookingFile = async (file, userId) => {
  if (!file) {
    console.warn("Nenhum arquivo selecionado.");
    return null;
  }

  const safeUserId = userId || "anonymous";
  const path = `${safeUserId}/${Date.now()}_${file.name}`;

  console.log("üì§ Enviando para Supabase:", {
    bucket: "bookings",
    path,
    fileName: file.name,
    sizeKB: (file.size / 1024).toFixed(1),
    type: file.type,
  });

  try {
    // Tenta o upload normalmente
    const { data, error } = await window.supabase.storage
      .from("bookings")
      .upload(path, file);

    // --- ‚öôÔ∏è Detalhes completos do retorno ---
    console.log("üß© Supabase response:", { data, error });

    if (error) {
      console.error("‚ùå Supabase upload failed:", error);
      alert(`Upload falhou: ${error.message}\n\nVerifique o console para mais detalhes.`);
      return null;
    }

    const publicURL = `${SUPABASE_URL}/storage/v1/object/public/bookings/${path}`;
    console.log("‚úÖ Upload conclu√≠do:", publicURL);
    return publicURL;

  } catch (e) {
    // Se for erro de rede ou de configura√ß√£o
    console.error("üî• Erro inesperado no upload:", e);
    alert(`Erro inesperado: ${e.message}`);
    return null;
  }
};
</script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
    .card { box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s; }
    .card:hover { transform: translateY(-2px); }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

  <!-- Main Booking Card -->
  <div class="card w-full max-w-md bg-white p-8 rounded-xl border border-gray-200">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">Book Your Session</h1>

    <div id="status-display" class="mb-6 p-4 rounded-lg text-center font-medium" role="status">
      Please connect your Ethereum wallet.
    </div>

    <div id="connection-info" class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg hidden">
      <p class="text-sm font-semibold text-indigo-700">Wallet Connected:</p>
      <p id="account-display" class="text-sm font-mono text-indigo-900 truncate mt-1"></p>
      <p class="text-sm font-semibold text-indigo-700 mt-2">Cost:</p>
      <p class="text-lg font-bold text-indigo-900" id="cost-display">0.00001 Sepolia ETH</p>
    </div>

    <div class="mb-4">
      <label for="appointment-slot" class="block text-sm font-medium text-gray-700 mb-2">
        Select Appointment Slot:
      </label>
      <select id="appointment-slot" class="w-full p-3 border border-gray-300 rounded-lg bg-white" disabled>
        <option value="" disabled selected>-- Choose a Time --</option>
        <option value="Mon, 10am UTC (Oct 28)">Monday, Oct 28 (10:00 UTC)</option>
        <option value="Wed, 2pm UTC (Oct 30)">Wednesday, Oct 30 (14:00 UTC)</option>
        <option value="Fri, 4pm UTC (Nov 1)">Friday, Nov 1 (16:00 UTC)</option>
      </select>
    </div>

    <!-- üÜï File Upload -->
    <div class="mb-4">
      <label for="booking-file" class="block text-sm font-medium text-gray-700 mb-2">
        Optional: Attach a note or screenshot (for your coach)
      </label>
      <input type="file" id="booking-file"
        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white" />
    </div>

    <div class="space-y-4">
      <button id="connect-btn"
        class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700"
        onclick="connectWallet()">Connect Wallet</button>
      <button id="book-btn"
        class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 hidden"
        onclick="bookAppointment()" disabled>Pay 0.00001 ETH and Book Appointment</button>
    </div>

    <div id="loading-spinner" class="mt-6 text-center hidden">
      <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-indigo-500 border-r-transparent"></div>
      <p class="text-indigo-600 mt-2 font-medium">Processing Transaction...</p>
    </div>
  </div>

  <script>
    const { ethers } = window;

    // --- Injected Firebase Config (from server.js)
    const parsedInjectedConfig = (typeof window.__firebase_config !== 'undefined' && window.__firebase_config !== null)
      ? (() => { try { return JSON.parse(window.__firebase_config); } catch (e) { console.error(e); return null; } })()
      : null;
    const firebaseConfig = parsedInjectedConfig;
    const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

    // --- Constants ---
    const COACH_ADDRESS = "0x8e843477103e3a968b4b335352358f5b12a45a62";
    const SEPOLIA_CHAIN_ID = 11155111;
    const APPOINTMENT_COST_ETH = 0.00001;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // --- DOM Elements ---
    const statusDisplay = document.getElementById('status-display');
    const connectBtn = document.getElementById('connect-btn');
    const bookBtn = document.getElementById('book-btn');
    const accountDisplay = document.getElementById('account-display');
    const connectionInfo = document.getElementById('connection-info');
    const loadingSpinner = document.getElementById('loading-spinner');
    const appointmentSlot = document.getElementById('appointment-slot');

    let provider, signer, db, auth, userId;

    function updateStatus(text, type='info') {
      statusDisplay.textContent = text;
      statusDisplay.className = 'mb-6 p-4 rounded-lg text-center font-medium';
      const colors = { success:'bg-green-100 text-green-800', error:'bg-red-100 text-red-800', warning:'bg-yellow-100 text-yellow-800', info:'bg-blue-100 text-blue-800' };
      statusDisplay.classList.add(...colors[type].split(' '));
    }

    async function checkNetwork(network) {
      const currentChainId = Number(network.chainId);
      if (currentChainId !== SEPOLIA_CHAIN_ID) {
        updateStatus("Please switch to Sepolia Test Network.", 'warning');
        bookBtn.disabled = true;
        return false;
      }
      updateStatus("Wallet connected on Sepolia. Ready to book.", 'info');
      appointmentSlot.disabled = false;
      bookBtn.disabled = appointmentSlot.value === "";
      return true;
    }

async function initializeFirebaseAndAuth() {
  if (!window.firebase || !firebaseConfig) {
    console.error("Firebase SDK or config missing.");
    updateStatus("Firebase config missing. Check server injection.", 'error');
    return false;
  }

  try {
    const app = window.firebase.initializeApp(firebaseConfig);
    db = window.firebase.getFirestore(app);
    auth = window.firebase.getAuth(app);
    window.firebase.setLogLevel('Debug');

    let credential;

    if (initialAuthToken && initialAuthToken !== "null") {
      credential = await window.firebase.signInWithCustomToken(auth, initialAuthToken);
    } else {
      credential = await window.firebase.signInAnonymously(auth);
    }

    // üîπ Espera garantir que o usu√°rio esteja definido
    await new Promise((resolve) => {
      window.firebase.onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          console.log("‚úÖ Firebase Auth success:", userId);
          resolve();
        }
      });
    });

    return true;
  } catch (e) {
    console.error("‚ùå Firebase initialization or auth failed:", e);
    updateStatus("Firebase init/auth failed: " + e.message, 'error');
    return false;
  }
}


    async function connectWallet() {
      if (!window.ethereum) {
        updateStatus("No Ethereum wallet found. Please install MetaMask.", 'error');
        return;
      }
      try {
        connectBtn.disabled = true;
        updateStatus("Connecting wallet...", 'info');

        // ‚úÖ Aguarda Firebase estar pronto antes de prosseguir
        const firebaseReady = await initializeFirebaseAndAuth();
        if (!firebaseReady) {
          updateStatus("Firebase initialization failed.", "error");
          connectBtn.disabled = false;
          return;
        }

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        const network = await provider.getNetwork();
        const account = await signer.getAddress();
        connectBtn.classList.add('hidden');
        bookBtn.classList.remove('hidden');
        connectionInfo.classList.remove('hidden');
        accountDisplay.textContent = account;

        window.ethereum.on('chainChanged', () => window.location.reload());
        await checkNetwork(network);
      } catch (e) {
        console.error("Wallet connect failed:", e);
        connectBtn.disabled = false;
        updateStatus("Connection failed: " + e.message, 'error');
      }
    }

async function saveBooking(payerAddress, txHash, selectedSlot, fileURL = null) {
  if (!db || !userId) {
    console.error("Firestore not initialized or user not authenticated.", { db, userId });
    return false;
  }

  const bookingData = {
    payerAddress,
    coachAddress: COACH_ADDRESS,
    appointmentTime: selectedSlot,
    costEth: APPOINTMENT_COST_ETH,
    transactionHash: txHash,
    fileURL,
    timestamp: new Date().toISOString(),
  };

  try {
    // Caminho corrigido (cole√ß√£o v√°lida)
    const collectionPath = `bookings/${userId}`;
    const docRef = await window.firebase.addDoc(
      window.firebase.collection(db, collectionPath),
      bookingData
    );

    console.log("‚úÖ Booking saved to Firestore:", docRef.id);
    return true;
  } catch (e) {
    console.error("‚ùå Error adding document to Firestore:", e);
    return false;
  }
}

    async function bookAppointment() {
      const slot = appointmentSlot.value;
      if (!signer || !slot) return updateStatus("Wallet not connected or slot missing.", 'error');
      const payerAddress = await signer.getAddress();
      bookBtn.disabled = true; appointmentSlot.disabled = true; loadingSpinner.classList.remove('hidden');
      updateStatus(`Booking ${slot}... Confirm in your wallet.`, 'warning');
      try {
        const tx = await signer.sendTransaction({
          to: COACH_ADDRESS,
          value: ethers.parseEther(APPOINTMENT_COST_ETH.toString())
        });
        updateStatus(`Transaction sent. Waiting for confirmation...`, 'warning');
        const receipt = await tx.wait();
        loadingSpinner.classList.add('hidden');
        if (receipt && receipt.status === 1) {
          // üÜï Upload optional file to Supabase
        const file = document.getElementById("booking-file").files[0];
        let fileURL = null;
        const safeUserId = userId || "anonymous";  // fallback if userId isn't ready

        if (file) {
          updateStatus("Uploading file to Supabase...", "info");
          fileURL = await window.uploadBookingFile(file, safeUserId);
        }
          const saved = await saveBooking(payerAddress, receipt.hash, slot, fileURL);
          const msg = saved ? "Booking saved successfully." : "Payment succeeded but booking not saved.";
          updateStatus(`üéâ SUCCESS! ${msg} Tx: ${receipt.hash}`, 'success');
        } else {
          updateStatus("Transaction failed on blockchain.", 'error');
          bookBtn.disabled = false; appointmentSlot.disabled = false;
        }
      } catch (e) {
        console.error("Payment error:", e);
        loadingSpinner.classList.add('hidden');
        bookBtn.disabled = false; appointmentSlot.disabled = false;
        const msg = e.code === 'ACTION_REJECTED'
          ? "Transaction rejected by user."
          : e.message.includes('insufficient funds')
            ? "Insufficient funds."
            : `Payment failed: ${e.message}`;
        updateStatus(msg, 'error');
      }
    }

    window.onload = () => {
      document.getElementById('cost-display').textContent = `${APPOINTMENT_COST_ETH} Sepolia ETH`;
      document.getElementById('book-btn').textContent = `Pay ${APPOINTMENT_COST_ETH} ETH and Book Appointment`;
      updateStatus(window.ethereum ? "MetaMask detected. Click Connect Wallet to begin." : "Install MetaMask to continue.", window.ethereum ? 'info' : 'error');
      appointmentSlot.addEventListener('change', () => { bookBtn.disabled = !(signer && appointmentSlot.value); });
    };
  </script>
</body>
</html>

